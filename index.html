<!DOCTYPE html>
<html>
<head>
    <title>Loan Calculator</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .input-group { margin: 10px 0; }
        label { display: inline-block; width: 180px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .event-section { background: #f8f8f8; padding: 15px; margin: 15px 0; }
    </style>
</head>
<body>
    <h1>Loan Calculator</h1>
    
    <div class="input-group">
        <label>Loan Amount:</label>
        <input type="number" id="principal" step="1000" value="100000">
    </div>
    
    <div class="input-group">
        <label>Start Date:</label>
        <input type="date" id="startDate" value="<?= date('Y-m-d') ?>">
    </div>
    
    <div class="input-group">
        <label>Initial Annual Rate (%):</label>
        <input type="number" id="initialRate" step="0.1" value="5">
    </div>
    
    <div class="input-group">
        <label>Loan Tenure (months):</label>
        <input type="number" id="tenure" value="12">
    </div>

    <div class="event-section">
        <h3>Add Events</h3>
        <div>
            <select id="eventType">
                <option value="rate">Rate Change</option>
                <option value="prepayment">Prepayment</option>
                <option value="emi">EMI Change</option>
            </select>
            <input type="date" id="eventDate">
            <input type="number" id="eventValue" placeholder="Value">
            <button onclick="addEvent()">Add Event</button>
        </div>
        <div id="eventList"></div>
    </div>

    <button onclick="calculate()" style="margin: 20px 0; padding: 10px 20px;">Calculate Schedule</button>

    <table id="result">
        <thead>
            <tr>
                <th>Date</th>
                <th>EMI</th>
                <th>Principal</th>
                <th>Interest</th>
                <th>Remaining</th>
                <th>Rate</th>
            </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
    </table>

    <script>
        let events = [];

        function addEvent() {
            const event = {
                type: document.getElementById('eventType').value,
                date: new Date(document.getElementById('eventDate').value),
                value: parseFloat(document.getElementById('eventValue').value)
            };
            
            events.push(event);
            updateEventList();
        }

        function updateEventList() {
            const list = document.getElementById('eventList');
            list.innerHTML = events.map((e, i) => 
                `<div>${e.type} on ${e.date.toISOString().split('T')[0]}: ${e.value}</div>`
            ).join('');
        }

        function calculateEMI(principal, monthlyRate, tenure) {
            if (tenure === 0 || monthlyRate === 0) return principal / tenure;
            const factor = Math.pow(1 + monthlyRate, tenure);
            return (principal * monthlyRate * factor) / (factor - 1);
        }

        function calculate() {
            const principal = parseFloat(document.getElementById('principal').value);
            const startDate = new Date(document.getElementById('startDate').value);
            const annualRate = parseFloat(document.getElementById('initialRate').value) / 100;
            const tenure = parseInt(document.getElementById('tenure').value);

            let currentPrincipal = principal;
            let monthlyRate = annualRate / 12;
            let schedule = [];
            let currentDate = new Date(startDate);
            let remainingTenure = tenure;

            // Sort events by date
            const sortedEvents = [...events].sort((a, b) => a.date - b.date);

            for (let month = 0; month < tenure; month++) {
                if (currentPrincipal <= 0) break;

                // Process events
                while (sortedEvents.length > 0 && 
                      sortedEvents[0].date <= currentDate) {
                    const event = sortedEvents.shift();
                    switch(event.type) {
                        case 'rate':
                            monthlyRate = event.value / 100 / 12;
                            break;
                        case 'prepayment':
                            currentPrincipal -= event.value;
                            break;
                        case 'emi':
                            emi = event.value;
                            break;
                    }
                }

                // Calculate EMI
                const emi = calculateEMI(currentPrincipal, monthlyRate, remainingTenure);
                const interest = currentPrincipal * monthlyRate;
                const principalPayment = Math.min(emi - interest, currentPrincipal);

                currentPrincipal -= principalPayment;
                remainingTenure--;

                schedule.push({
                    date: new Date(currentDate),
                    emi: emi,
                    principal: principalPayment,
                    interest: interest,
                    remaining: currentPrincipal,
                    rate: monthlyRate * 12 * 100
                });

                currentDate.setMonth(currentDate.getMonth() + 1);
            }

            displaySchedule(schedule);
        }

        function displaySchedule(schedule) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = schedule.map(payment => `
                <tr>
                    <td>${payment.date.toISOString().split('T')[0]}</td>
                    <td>${payment.emi.toFixed(2)}</td>
                    <td>${payment.principal.toFixed(2)}</td>
                    <td>${payment.interest.toFixed(2)}</td>
                    <td>${Math.max(payment.remaining, 0).toFixed(2)}</td>
                    <td>${payment.rate.toFixed(2)}%</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
